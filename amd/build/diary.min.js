define("lytix_diary/diary",["exports","jquery","core/ajax","core/modal_factory","core/modal_events","core/fragment","core/templates","core/yui","lytix_helper/widget","lytix_logs/logs"],(function(_exports,_jquery,_ajax,_modal_factory,_modal_events,_fragment,_templates,_yui,_widget,_logs){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates),_yui=_interopRequireDefault(_yui);var log,fn,_ref,moment=window.moment,diary={contextid:-1,courseid:-1,userid:-1,strings:null,semStart:null,semEnd:null,drawLoading:function(){document.getElementById("lytix_diary").innerHTML='<img src="../../../pix/i/loading.gif" alt="LoadingImage" style="width:48px;height:48px;"> '+diary.strings.loading_msg},drawdiary:function(){_ajax.default.call([{methodname:"local_lytix_lytix_diary_get",args:{contextid:diary.contextid,courseid:diary.courseid,userid:diary.userid}}])[0].done((function(response){return diary.semStart=moment.unix(response.semStart),diary.semEnd=moment.unix(response.semEnd),_templates.default.render("lytix_diary/diary_table",response).then((function(html){(0,_jquery.default)("#lytix_diary").html(html)})).fail((function(ex){diary.renderTableFail(ex)}))}))},setAddListener:function(){(0,_jquery.default)("#page").on("click","#add_diary_entry",(function(){log("OPEN","DIARY"),diary.createDiaryEntryModal({id:-1,userid:diary.userid,courseid:diary.courseid})}))},setEditListener:function(){(0,_jquery.default)("#page").on("click",".editdiaryentry",(function(){var id=(0,_jquery.default)(this).attr("id");log("OPEN","DIARY",null,id),_ajax.default.call([{methodname:"local_lytix_lytix_diary_entry_get",args:{contextid:diary.contextid,courseid:diary.courseid,userid:diary.userid,id:id}}])[0].done((function(response){null!==response.entry&&diary.createDiaryEntryModal(response.entry)}))}))},setDeleteListener:function(){(0,_jquery.default)("#page").on("click",".removediaryentry",(function(){var id=(0,_jquery.default)(this).attr("id");diary.deleteDiaryEntry(id)}))},renderTableFail:function(ex){var text=diary.strings.error_text+"<p>"+ex.message+"</p>";(0,_jquery.default)("#lytix_diary").html(text)},renderModalFail:function(ex,id){var text=diary.strings.error_text+"<p>"+ex.message+"</p>";(0,_jquery.default)("#"+id+".modal-body").html(text)},createDiaryEntryModal:function(item){var trigger=(0,_jquery.default)("#create-modal"),form=(0,_fragment.loadFragment)("lytix_diary","new_diary_entry_form",diary.contextid,item),title=diary.strings.diary_entry;_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:title,body:form},trigger).done((function(modal){modal.setLarge(),modal.show();var root=modal.getRoot();root.on(_modal_events.default.save,(function(m){var formData=root.find("form").serialize();if(""===document.getElementById("id_title").value)m.preventDefault();else{var timestampofentry=new Date(document.getElementById("id_startdate_year").value,document.getElementById("id_startdate_month").value-1,document.getElementById("id_startdate_day").value).getTime();if(timestampofentry<diary.semStart||timestampofentry>diary.semEnd)m.preventDefault(),modal.setBody(modal.getBody().innerHTML),modal.getBody().append(diary.strings.date_out_of_range);else{var mandatoryFlag=!0,starthour=parseInt(document.getElementById("id_startdate_hour").value),endhour=parseInt(document.getElementById("id_hour").value),endminute=parseInt(document.getElementById("id_minute").value),startminute=parseInt(document.getElementById("id_startdate_minute").value);if((endhour<starthour||starthour===endhour&&endminute<startminute)&&(mandatoryFlag=!1,m.preventDefault(),modal.setBody(modal.getBody().innerHTML),modal.getBody().append(diary.strings.time_smaller)),mandatoryFlag)_ajax.default.call([{methodname:"local_lytix_lytix_diary_entry",args:{contextid:diary.contextid,jsonformdata:JSON.stringify(formData)}}])[0].done((function(){diary.resetModal(),diary.drawdiary()})).fail((function(ex){window.console.log(ex),diary.resetModal()}))}}})),root.on(_modal_events.default.hidden,(function(){log("CLOSE","DIARY",null,item.id),modal.hide(),modal.destroy()})),root.on(_modal_events.default.cancel,(function(){diary.resetModal()}))}))},deleteDiaryEntry:function(id){var trigger=(0,_jquery.default)("#create-modal"),title=diary.strings.diary,body=_templates.default.render("lytix_diary/delete_entry",{});_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:title,body:body},trigger).done((function(modal){modal.show();var root=modal.getRoot();root.on(_modal_events.default.save,(function(){_ajax.default.call([{methodname:"local_lytix_lytix_diary_delete_entry",args:{contextid:diary.contextid,courseid:diary.courseid,userid:diary.userid,id:id}}])[0].done((function(response){response.success&&(diary.drawdiary(),diary.resetModal())})).fail((function(ex){diary.renderModalFail(ex,modal.body[0].id),modal.show()}))})),root.on(_modal_events.default.cancel,(function(){diary.resetModal()}))}))},resetModal:function(){_yui.default.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()}))}},init=(fn=regeneratorRuntime.mark((function _callee(contextid,courseid,userid){return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return diary.contextid=contextid,diary.courseid=courseid,diary.userid=userid,_context.next=5,(0,_widget.getStrings)({lytix_diary:{identical:["error_text","diary_entry","diary","loading_msg","title_required","date_out_of_range","time_smaller"]}});case 5:diary.strings=_context.sent,log=(0,_logs.makeLoggingFunction)(userid,courseid,contextid,"diary"),diary.drawLoading(),diary.drawdiary(),diary.setEditListener(),diary.setDeleteListener(),diary.setAddListener();case 12:case"end":return _context.stop()}}),_callee)})),_ref=function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))},function(_x,_x2,_x3){return _ref.apply(this,arguments)});_exports.init=init}));

//# sourceMappingURL=diary.min.js.map