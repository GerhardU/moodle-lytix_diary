{"version":3,"file":"diary.min.js","sources":["../src/diary.js"],"sourcesContent":["import $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {loadFragment} from 'core/fragment';\nimport Templates from 'core/templates';\nimport Yui from 'core/yui';\nimport {getStrings} from 'lytix_helper/widget';\nimport {makeLoggingFunction} from 'lytix_logs/logs';\n\nconst moment = window.moment;\n\nlet log; // This will be the logging function.\n\nvar diary = {\n\n    contextid: -1,\n    courseid: -1,\n    userid: -1,\n    strings: null,\n    semStart: null,\n    semEnd: null,\n\n    drawLoading: function() {\n        var img = '<img src=\"../../../pix/i/loading.gif\" ' +\n            'alt=\"LoadingImage\" style=\"width:48px;height:48px;\">';\n        var widget = document.getElementById('lytix_diary');\n        widget.innerHTML = img + ' ' + diary.strings.loading_msg;\n    },\n    drawdiary: function() {\n        var promises = Ajax.call([\n            {\n                methodname: 'local_lytix_lytix_diary_get',\n                args: {\n                    contextid: diary.contextid, courseid: diary.courseid, userid: diary.userid},\n            }\n        ]);\n        promises[0].done(function(response) {\n            diary.semStart = moment.unix(response.semStart);\n            diary.semEnd = moment.unix(response.semEnd);\n            return Templates.render('lytix_diary/diary_table', response)\n            .then(html => {\n                $('#lytix_diary').html(html);\n                return;\n            })\n            .fail(function(ex) {\n                diary.renderTableFail(ex);\n            });\n        });\n    },\n\n    setAddListener: function() {\n        // Set click listener to add button.\n        $(\"#page\").on('click', '#add_diary_entry', function() {\n            log('OPEN', 'DIARY');\n            diary.createDiaryEntryModal({id: -1, userid: diary.userid, courseid: diary.courseid});\n        });\n    },\n\n    setEditListener: function() {\n        // Set click listener to every row.\n        $(\"#page\").on('click', '.editdiaryentry', function() {\n            var id = $(this).attr('id');\n            log('OPEN', 'DIARY', null, id);\n            var promises = Ajax.call([\n                {\n                    methodname: 'local_lytix_lytix_diary_entry_get',\n                    args: {\n                        contextid: diary.contextid, courseid: diary.courseid, userid: diary.userid, id: id\n                    },\n                }\n            ]);\n            promises[0].done(function(response) {\n                if (response.entry !== null) {\n                    diary.createDiaryEntryModal(response.entry);\n                }\n            });\n        });\n    },\n\n    setDeleteListener: function() {\n        // Set click listener to every row.\n        $(\"#page\").on('click', '.removediaryentry', function() {\n            var id = $(this).attr('id');\n            diary.deleteDiaryEntry(id);\n        });\n    },\n\n    renderTableFail: function(ex) {\n        var text = diary.strings.error_text + '<p>' + ex.message + '</p>';\n        $('#lytix_diary').html(text);\n    },\n\n    renderModalFail: function(ex, id) {\n        var text = diary.strings.error_text + '<p>' + ex.message + '</p>';\n        $('#' + id + '.modal-body').html(text);\n    },\n\n    createDiaryEntryModal: function(item) {\n        var trigger = $('#create-modal');\n        var form = loadFragment('lytix_diary', 'new_diary_entry_form', diary.contextid, item);\n        var title = diary.strings.diary_entry;\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: title,\n            body: form,\n        }, trigger).done(function(modal) {\n            // Forms are big, we want a big modal.\n            modal.setLarge();\n            modal.show();\n            var root = modal.getRoot();\n            root.on(ModalEvents.save, function(m) {\n                // Convert all the form elements values to a serialised string.\n                var formData = root.find('form').serialize();\n                // Check for mandatory values.\n                if (document.getElementById('id_title').value === \"\") {\n                    m.preventDefault();\n                } else {\n                    let diaryDate = new Date(document.getElementById('id_startdate_year').value,\n                        document.getElementById('id_startdate_month').value - 1,\n                        document.getElementById('id_startdate_day').value);\n                    var timestampofentry = diaryDate.getTime();\n                    if (timestampofentry < diary.semStart || timestampofentry > diary.semEnd) {\n                        m.preventDefault();\n                        modal.setBody(modal.getBody().innerHTML);\n                        modal.getBody().append(diary.strings.date_out_of_range);\n                    } else {\n                        var mandatoryFlag = true;\n                        var starthour = parseInt(document.getElementById('id_startdate_hour').value);\n                        var endhour = parseInt(document.getElementById('id_hour').value);\n                        var endminute = parseInt(document.getElementById('id_minute').value);\n                        var startminute = parseInt(document.getElementById('id_startdate_minute').value);\n                        if ((endhour < starthour) || (starthour === endhour && endminute < startminute)) {\n                            mandatoryFlag = false;\n                            m.preventDefault();\n                            modal.setBody(modal.getBody().innerHTML);\n                            modal.getBody().append(diary.strings.time_smaller);\n                        }\n                        if (mandatoryFlag) {\n                            // Call the webservice with formData as param.\n                            var promises = Ajax.call([\n                                {\n                                    methodname: 'local_lytix_lytix_diary_entry',\n                                    args: {contextid: diary.contextid, jsonformdata: JSON.stringify(formData)},\n                                }\n                            ]);\n                            promises[0].done(function() {\n                                diary.resetModal();\n                                diary.drawdiary();\n                            }).fail(function(ex) {\n                                // TODO Find solution to show error message in modal.\n                                window.console.log(ex);\n                                diary.resetModal();\n                            });\n                        }\n                    }\n                }\n            });\n            root.on(ModalEvents.hidden, function() {\n                log('CLOSE', 'DIARY', null, item.id);\n                modal.hide();\n                modal.destroy();\n            });\n            root.on(ModalEvents.cancel, function() {\n                diary.resetModal();\n            });\n        });\n    },\n\n    deleteDiaryEntry: function(id) {\n        var trigger = $('#create-modal');\n        var title = diary.strings.diary;\n        var body = Templates.render('lytix_diary/delete_entry', {});\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: title,\n            body: body,\n        }, trigger).done(function(modal) {\n            // Forms are big, we want a big modal.\n            modal.show();\n            var root = modal.getRoot();\n            root.on(ModalEvents.save, function() {\n                // Convert all the form elements values to a serialised string.\n                var promises = Ajax.call([\n                    {\n                        methodname: 'local_lytix_lytix_diary_delete_entry',\n                        args: {\n                            contextid: diary.contextid, courseid: diary.courseid,\n                            userid: diary.userid, id: id,\n                        },\n                    },\n                ]);\n                promises[0].done(function(response) {\n                    if (response.success) {\n                        diary.drawdiary();\n                        diary.resetModal();\n                    }\n                }).fail(function(ex) {\n                    diary.renderModalFail(ex, modal.body[0].id);\n                    modal.show();\n                });\n            });\n            root.on(ModalEvents.cancel, function() {\n                diary.resetModal();\n            });\n        });\n    },\n\n    resetModal: function() {\n        Yui.use('moodle-core-formchangechecker', function() {\n            M.core_formchangechecker.reset_form_dirty_state();\n        });\n        // Reload that changes in table are done too.\n        // document.location.reload();\n    },\n};\n\nexport const init = async (contextid, courseid, userid) => { // eslint-disable-line space-before-function-paren\n    diary.contextid = contextid;\n    diary.courseid = courseid;\n    diary.userid = userid;\n    diary.strings = await getStrings({\n        lytix_diary: { // eslint-disable-line camelcase\n            identical: [\n                \"error_text\",\n                \"diary_entry\",\n                \"diary\",\n                \"loading_msg\",\n                \"title_required\",\n                \"date_out_of_range\",\n                \"time_smaller\",\n            ],\n        },\n    });\n\n    log = makeLoggingFunction(userid, courseid, contextid, 'diary');\n\n    diary.drawLoading();\n    diary.drawdiary();\n    diary.setEditListener();\n    diary.setDeleteListener();\n    diary.setAddListener();\n};\n"],"names":["moment","window","log","diary","contextid","courseid","userid","strings","semStart","semEnd","drawLoading","document","getElementById","innerHTML","img","loading_msg","drawdiary","Ajax","call","methodname","args","done","response","unix","Templates","render","then","html","fail","ex","renderTableFail","setAddListener","on","createDiaryEntryModal","id","setEditListener","this","attr","entry","setDeleteListener","deleteDiaryEntry","text","error_text","message","renderModalFail","item","trigger","form","title","diary_entry","create","type","ModalFactory","types","SAVE_CANCEL","body","modal","setLarge","show","root","getRoot","ModalEvents","save","m","formData","find","serialize","value","preventDefault","timestampofentry","Date","getTime","setBody","getBody","append","date_out_of_range","mandatoryFlag","starthour","parseInt","endhour","endminute","startminute","time_smaller","jsonformdata","JSON","stringify","resetModal","console","hidden","hide","destroy","cancel","success","use","M","core_formchangechecker","reset_form_dirty_state","async","lytix_diary","identical"],"mappings":"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"}